<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #dde7df;
            justify-content: center;
            
        }
        table {
            width: 1600px; /* Fixed width */
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            background: #f5f7f6;
        }
        h1 {
            color: #2b4d37;
            text-transform: uppercase;
        }
        td, th {
            border: 1px solid #ccc;
            text-align: center;
            padding: 5px;
            width: 8.3%; /* Fixed column width */
            min-height: 50px; /* Fixed row height */
            overflow: hidden;
            font: 14px sans-serif;
            text-wrap:balance;
            
        }
        td{
            background: #ffffff ;
            font-size: 14px;
            line-height: 1.4;
        }
        th {
            background: #2b4d37;
            color: white;
            text-transform: uppercase;
        }
        .report-cell {
            background: #ffd4d4 !important;
            cursor: default !important;
            font: 12px sans-serif;
        }
        .container {
            overflow-x: auto; /* Horizontal scroll */
            white-space: nowrap;
            background: white;
            width: 95%;
            max-width: 1200px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        button {
            margin: 5px 0;
            padding: 8px 16px;
            font-size: 16px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 2px solid #2b4d37;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            z-index: 1000;
        }
        .popup label {
            display: block;
            margin-bottom: 10px;
        }
        .table-container {
            
            white-space: nowrap;
            width: 100%;
            max-width: 100%;
            background: white;
            padding: 20px;
            margin-right: 5px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            overflow-x: auto; /* Enable horizontal scrolling */
            
        }
        .add-batch-btn{
            background-color: #2b4d37;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 10px;
            
        }
        .add-batch-div
        {
            display: flex;
            align-items: center;
            margin-top: 50px;
        }
        #highlight {
            background-color: #d0e7d2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="add-batch-div">
        <button class="add-batch-btn" onclick="openBatchPopup()">Add Batch</button>
    </div>
    <div id="batchPopup" class="popup">
        <h3>Enter Batch Details</h3>
        <label>Year: 
            <select id="year">
                <option>1st</option>
                <option>2nd</option>
                <option>3rd</option>
                <option>4th</option>
            </select>
        </label><br>
        <label>Semester: 
            <select id="semester">
                <option>Odd</option>
                <option>Even</option>
            </select>
        </label><br>
        <label>Batch Name: <input type="text" id="batchName"></label><br>
        <button onclick="addRows()">Add</button>
        <button onclick="closeBatchPopup()">Cancel</button>
    </div>
    
    <div class="table-container">
        <div class="table-sat">
            <div style="display: flex;
            justify-content: center;
            align-items: center;"><h1>Class Routine</h1></div>
            <div>
                <table id="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Saturday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable">
                    <tbody>
                        <script>
                            // Create column-wise 2nd and 3rd line duplicate report at the last row
                            document.write("<tr>");
                            for (let j = 0; j < 11; j++) {
                                if(j == 0){
                                    document.write(`<td class="report-cell" id="colReport${j}">Duplicate <br> Teachers <br> & rooms</td>`);
                                }else{
                                    document.write(`<td class="report-cell" id="colReport${j}"></td>`);
                                }
                            }
                            // Extra cell for alignment at last row last column
                            document.write(`<td class="report-cell" style="display:hidden"></td>`);
                            document.write("</tr>");
                        </script>
                    </tbody>
                </table>            
            </div>
            <div id="popup" class="popup">
                <h3>Edit Cell</h3>
                <label>Course Code: <input type="text" id="courseCode"</label>
        
                <!-- Teacher Section -->
                <div id="teacherContainer">
                    <label>Teacher: <input type="text" name="teacher"></label>
                </div>
                <button type="button" onclick="addTeacher()">Add Teacher</button><br><br>
        
                <!-- Room Number Section -->
                <div id="roomContainer">
                    <label>Room Number: <input type="text" name="room"></label>
                </div>
                <button type="button" onclick="addRoom()">Add Room</button><br><br>
                <br><br>
                <button onclick="saveCell()">Save</button>
                <button onclick="closePopup()">Cancel</button>
            </div>
        </div>
        <div class="table-sun">     
                <table class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Sunday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable">
                    <tbody>
                        <script>
                            // Create column-wise 2nd and 3rd line duplicate report at the last row
                            document.write("<tr>");
                            for (let j = 0; j < 11; j++) {
                                if(j == 0){
                                    document.write(`<td class="report-cell" id="colReport${j}">Duplicate <br> Teachers <br> & rooms</td>`);
                                }else{
                                    document.write(`<td class="report-cell" id="colReport${j}"></td>`);
                                }
                            }
                            // Extra cell for alignment at last row last column
                            document.write(`<td class="report-cell" style="display:hidden"></td>`);
                            document.write("</tr>");
                        </script>
                    </tbody>
                </table>            
        </div>
        <div class="table-mon">     
                <table class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Monday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable">
                    <tbody>
                        <script>
                            // Create column-wise 2nd and 3rd line duplicate report at the last row
                            document.write("<tr>");
                            for (let j = 0; j < 11; j++) {
                                if(j == 0){
                                    document.write(`<td class="report-cell" id="colReport${j}">Duplicate <br> Teachers <br> & rooms</td>`);
                                }else{
                                    document.write(`<td class="report-cell" id="colReport${j}"></td>`);
                                }
                            }
                            // Extra cell for alignment at last row last column
                            document.write(`<td class="report-cell" style="display:hidden"></td>`);
                            document.write("</tr>");
                        </script>
                    </tbody>
                </table>            
        </div>
        <div class="table-tue">     
                <table class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Tuesday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable">
                    <tbody>
                        <script>
                            // Create column-wise 2nd and 3rd line duplicate report at the last row
                            document.write("<tr>");
                            for (let j = 0; j < 11; j++) {
                                if(j == 0){
                                    document.write(`<td class="report-cell" id="colReport${j}">Duplicate <br> Teachers <br> & rooms</td>`);
                                }else{
                                    document.write(`<td class="report-cell" id="colReport${j}"></td>`);
                                }
                            }
                            // Extra cell for alignment at last row last column
                            document.write(`<td class="report-cell" style="display:hidden"></td>`);
                            document.write("</tr>");
                        </script>
                    </tbody>
                </table>            
        </div>
        <div class="table-wed">     
                <table class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Wednsday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable">
                    <tbody>
                        <script>
                            // Create column-wise 2nd and 3rd line duplicate report at the last row
                            document.write("<tr>");
                            for (let j = 0; j < 11; j++) {
                                if(j == 0){
                                    document.write(`<td class="report-cell" id="colReport${j}">Duplicate <br> Teachers <br> & rooms</td>`);
                                }else{
                                    document.write(`<td class="report-cell" id="colReport${j}"></td>`);
                                }
                            }
                            // Extra cell for alignment at last row last column
                            document.write(`<td class="report-cell" style="display:hidden"></td>`);
                            document.write("</tr>");
                        </script>
                    </tbody>
                </table>            
        </div>


            <div id="popup" class="popup">
                <h3>Edit Cell</h3>
                <label>Course Code: <input type="text" id="courseCode"</label>
        
                <!-- Teacher Section -->
                <div id="teacherContainer">
                    <label>Teacher: <input type="text" name="teacher"></label>
                </div>
                <button type="button" onclick="addTeacher()">Add Teacher</button><br><br>
        
                <!-- Room Number Section -->
                <div id="roomContainer">
                    <label>Room Number: <input type="text" name="room"></label>
                </div>
                <button type="button" onclick="addRoom()">Add Room</button><br><br>
                <br><br>
                <button onclick="saveCell()">Save</button>
                <button onclick="closePopup()">Cancel</button>
            </div>
        </div>
    </div>
        
        

    <script>
        let batchCounter = 1;
        let selectedCell;

        function openBatchPopup() {
            document.getElementById("batchPopup").style.display = "block";
        }

        function closeBatchPopup() {
            document.getElementById("batchPopup").style.display = "none";
        }
        function getLightColor() {
            // Generate R, G, B values in the range (150-255) to ensure a light color
            let r = 255; // 150 to 255
            let g = 255;
            let b =255;
            return `rgb(${r}, ${g}, ${b})`;
        }

        function addRows() {
            let table = document.getElementById("dynamicTable").getElementsByTagName('tbody')[0];
            let year = document.getElementById("year").value;
            let semester = document.getElementById("semester").value;
            let batchName = document.getElementById("batchName").value;
            let sections = ["A section", "B section", "C section"];
            let rowGroup = [];
            let color = getLightColor();
            let currentRow_number = table.rows.length + 1;
            console.log("Number Of Rows: "+currentRow_number);
            for (let i = 0; i < 3; i++) {
                let newRow = table.insertRow();
                rowGroup.push(newRow);
                
                for (let j = 0; j < 11; j++) {
                    let cell = newRow.insertCell(j);
                    cell.style.backgroundColor = color;
                    if (j === 0) {
                        cell.innerHTML = `${year} Year<br>${semester} Semester<br>${sections[i]}<br>(${batchName})`;
                    }
                    else if(j === 10)
                    {
                        cell.classList.add("report-cell");
                        cell.setAttribute("id", `rowReport${i + currentRow_number}`);
                        console.log(`rowReport${i + currentRow_number}`);
                    }
                    else {
                        cell.innerHTML = ``;
                        cell.onclick = function () { openPopup(this); };
                    }
                }
            }

            let deleteCell = rowGroup[0].insertCell(11);
            let deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.onclick = function () { deleteRows(rowGroup); };
            deleteCell.appendChild(deleteButton);
            closeBatchPopup();
        }

        function openPopup(cell) {
            if (cell.classList.contains("report-cell")) return; 
            selectedCell = cell; // Store the clicked cell
            document.getElementById("popup").style.display = "block";

            // Pre-fill with existing values (if available)
            let existingData = cell.innerText.split("\n");
            document.getElementById("courseCode").value = existingData[0] || "";

            // Reset dynamic fields
            document.getElementById("teacherContainer").innerHTML = "";
            document.getElementById("roomContainer").innerHTML = "";

            if (existingData[1]) {
                existingData[1].split("/").forEach(teacher => addTeacher(teacher));
            } else {
                addTeacher(); // Add one empty teacher input
            }

            if (existingData[2]) {
                existingData[2].split("/").forEach(room => addRoom(room));
            } else {
                addRoom(); // Add one empty room input
            }
            //document.getElementById("expandCell").checked = selectedCell.hasAttribute("colspan") && selectedCell.getAttribute("colspan") === "3";
        }

        function closePopup() {
            document.getElementById("popup").style.display = "none";
        }

        function addTeacher(value = "") {
            let teacherContainer = document.getElementById("teacherContainer");
            let newTeacherInput = document.createElement("label");
            newTeacherInput.innerHTML = `Teacher: <input type="text" name="teacher" value="${value}"> 
                <button type="button" onclick="removeElement(this)">Remove</button>`;
            teacherContainer.appendChild(newTeacherInput);
        }

        function addRoom(value = "") {
            let roomContainer = document.getElementById("roomContainer");
            let newRoomInput = document.createElement("label");
            newRoomInput.innerHTML = `Room Number: <input type="text" name="room" value="${value}"> 
                <button type="button" onclick="removeElement(this)">Remove</button>`;
            roomContainer.appendChild(newRoomInput);
        }

        function removeElement(button) {
            button.parentElement.remove();
        }

        function saveCell() {
            if (!selectedCell) return;

            let courseCode = document.getElementById("courseCode").value;
            let teachers = Array.from(document.getElementsByName("teacher")).map(input => input.value).filter(Boolean);
            let rooms = Array.from(document.getElementsByName("room")).map(input => input.value).filter(Boolean);
            //let expandCell = document.getElementById("expandCell").checked;
            let lastChar = courseCode.trim().slice(-1); // Get the last character
            let lastDigit = parseInt(lastChar, 10); // Convert to number
            let row = selectedCell.parentElement;
            let cellIndex = Array.from(row.children).indexOf(selectedCell);
            
            if (!isNaN(lastDigit)) {
                if (lastDigit % 2 === 0) {
                    let lab_positions = [1,4,7];
                    if (!lab_positions.includes(cellIndex)) {
                        alert(`Sessional courses are only allowed in 1st, 4th, and 7th periods.`);
                        closePopup();
                        return;
                    }
                    selectedCell.setAttribute("colspan", "3");
                    let next1 = row.children[cellIndex + 1];
                    let next2 = row.children[cellIndex + 2];

                    if (next1){
                        next1.innerText = `${courseCode},${teachers.join("/")},${rooms.join("/")}`;
                        next1.style.display = "none";
                    }
                    if (next2){
                        next2.innerText = `${courseCode},${teachers.join("/")},${rooms.join("/")}`;
                        next2.style.display = "none";
                    }
                } else {
                    selectedCell.setAttribute("colspan", "1");
                    // Restore hidden cells
                    let next1 = row.children[cellIndex + 1];
                    let next2 = row.children[cellIndex + 2];
                    if (next1)
                    {
                        if(next1.style.display == "none")
                        {
                            next1.style.display = "table-cell";
                            next1.innerText = "";
                        }
                    }
                    if (next2)
                    {
                        if(next2.style.display == "none")
                        {
                            next2.style.display = "table-cell";
                            next2.innerText = "";
                        }
                    }
                }
                selectedCell.innerText = `${courseCode}\n${teachers.join("/")}\n${rooms.join("/")}`;
                checkDuplicates();
                closePopup();
            } else if(!courseCode)
            {
                selectedCell.setAttribute("colspan", "1");
                // Restore hidden cells
                let next1 = row.children[cellIndex + 1];
                let next2 = row.children[cellIndex + 2];
                if (next1)
                {
                    if(next1.style.display == "none")
                    {
                        next1.style.display = "table-cell";
                        next1.innerText = "";
                    }
                }
                if (next2)
                {
                    if(next2.style.display == "none")
                    {
                        next2.style.display = "table-cell";
                        next2.innerText = "";
                    }
                }
                selectedCell.innerText = "";
                checkDuplicates();
                closePopup();
            }
            else {
                alert("Invalid course code. Please enter a valid course code.");
                closePopup()
                return;
            }
        }

        function deleteRows(rows) {
            let userResponse = confirm("Are you sure you want to delete this item?");
            if (userResponse) {
                rows.forEach(row => row.remove());
                alert("Item deleted successfully!");
            } else {
                alert("Delete operation canceled.");
            }
        }

        function checkDuplicates() {
            let colwise_table = document.getElementById("routineTable");
            let rowwise_table = document.getElementById("dynamicTable");
            let rows = rowwise_table.rows;
            let columns = 10;
            console.log("Duplicate: "+rows.length);
            for (let i = 1; i < rows.length; i++) {
                let firstLineSet = new Set();
                let firstLineDuplicates = [];

                for (let j = 1; j < 10; j++) {
                    if(rows[i].cells[j].style.display == "none")
                    {
                        continue;
                    }
                    let cellText = rows[i].cells[j].innerText.split("\n");
                    let firstLine = cellText[0] || "";

                    if (firstLine && firstLineSet.has(firstLine)) firstLineDuplicates.push(firstLine);
                    else firstLineSet.add(firstLine);
                }
                console.log(`rowReport${i}`);
                document.getElementById(`rowReport${i}`).innerText = `${[...new Set(firstLineDuplicates)].join(", ")}`;
            }

            for (let j = 1; j < 10; j++) {
                let secondLineSet = new Set();
                let thirdLineSet = new Set();
                let secondLineDuplicates = [];
                let thirdLineDuplicates = [];

                for (let i = 1; i < rows.length; i++) {
                    console.log(i+" "+j+" "+rows[i].cells[j].innerText);
                    let cellText = ""; 
                    if(rows[i].cells[j].style.display == "none")
                    {
                        cellText = rows[i].cells[j].innerText.split(",");
                    }else{
                        cellText = rows[i].cells[j].innerText.split("\n");
                    }  
                    let secondLine = cellText[1] || "";
                    let thirdLine = cellText[2] || "";

                    if (secondLine) {
                        secondLine.split("/").forEach(teacher => {
                            if (secondLineSet.has(teacher)) secondLineDuplicates.push(teacher);
                            else secondLineSet.add(teacher);
                        });
                    }
                    if (thirdLine) {
                        thirdLine.split("/").forEach(room => {
                            if (thirdLineSet.has(room)) thirdLineDuplicates.push(room);
                            else thirdLineSet.add(room);
                        });
                    }
                }

                document.getElementById(`colReport${j}`).innerText = `T:[${[...new Set(secondLineDuplicates)].join(", ")}]\nR:[${[...new Set(thirdLineDuplicates)].join(", ")}]`;
            }
        }
    </script>
</body>
</html>
