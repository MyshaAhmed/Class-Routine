<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #dde7df;
            justify-content: center;
            
        }
        table {
            width: 1600px; /* Fixed width */
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            background: #f5f7f6;
        }
        h1 {
            color: #2b4d37;
            text-transform: uppercase;
        }
        td, th {
            border: 1px solid #ccc;
            text-align: center;
            padding: 5px;
            width: 8.3%; /* Fixed column width */
            min-height: 50px; /* Fixed row height */
            overflow: hidden;
            font: 14px sans-serif;
            text-wrap:balance;
            
        }
        td{
            background: #ffffff ;
            font-size: 14px;
            line-height: 1.4;
        }
        th {
            background: #2b4d37;
            color: white;
            text-transform: uppercase;
        }
        .report-cell {
            background: #ffd4d4 !important;
            cursor: default !important;
            font: 12px sans-serif;
        }
        .container {
            overflow-x: auto; /* Horizontal scroll */
            white-space: nowrap;
            background: white;
            width: 95%;
            max-width: 1200px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        button {
            margin: 5px 0;
            padding: 8px 16px;
            font-size: 16px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 2px solid #2b4d37;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            z-index: 1000;
        }
        .popup label {
            display: block;
            margin-bottom: 10px;
        }
        .table-container {
            
            white-space: nowrap;
            width: 100%;
            max-width: 100%;
            background: white;
            padding: 20px;
            margin-right: 5px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            overflow-x: auto; /* Enable horizontal scrolling */
            
        }
        .add-batch-btn{
            background-color: #2b4d37;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 10px;
            
        }
        .add-batch-div
        {
            display: flex;
            align-items: center;
            margin-top: 50px;
        }
        #highlight {
            background-color: #d0e7d2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="add-batch-div">
        <button class="add-batch-btn" onclick="openBatchPopup()">Add Batch</button>
    </div>
    <div id="batchPopup" class="popup">
        <h3>Enter Batch Details</h3>
        <label>Year: 
            <select id="year">
                <option>1st</option>
                <option>2nd</option>
                <option>3rd</option>
                <option>4th</option>
            </select>
        </label><br>
        <label>Semester: 
            <select id="semester">
                <option>Odd</option>
                <option>Even</option>
            </select>
        </label><br>
        <label>Batch Name: <input type="text" id="batchName"></label><br>
        <button onclick="addRows()">Add</button>
        <button onclick="closeBatchPopup()">Cancel</button>
    </div>
    
    <div class="table-container">
        <div class="table-sat">
            <div style="display: flex;
            justify-content: center;
            align-items: center;"><h1>Class Routine</h1></div>
            <div>
                <table id="dynamicTable-sat" class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Saturday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable-sat" class="routineTable">
                    <tbody>
                        <tr>
                            <td class="report-cell" id="colReport-sat-0">Duplicate <br> Teachers <br> & rooms</td>
                            <td class="report-cell" id="colReport-sat-1"></td>
                            <td class="report-cell" id="colReport-sat-2"></td>
                            <td class="report-cell" id="colReport-sat-3"></td>
                            <td class="report-cell" id="colReport-sat-4"></td>
                            <td class="report-cell" id="colReport-sat-5"></td>
                            <td class="report-cell" id="colReport-sat-6"></td>
                            <td class="report-cell" id="colReport-sat-7"></td>
                            <td class="report-cell" id="colReport-sat-8"></td>
                            <td class="report-cell" id="colReport-sat-9"></td>
                            <td class="report-cell" id="colReport-sat-10"></td>
                            <td class="report-cell" style="display:hidden"></td>
                        </tr>
                    </tbody>
                </table>            
            </div>
        </div>
        <div class="table-sun">     
                <table id="dynamicTable-sun" class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Sunday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable-sun" class="routineTable">
                    <tbody>
                        <tr>
                            <td class="report-cell" id="colReport-sun-0">Duplicate <br> Teachers <br> & rooms</td>
                            <td class="report-cell" id="colReport-sun-1"></td>
                            <td class="report-cell" id="colReport-sun-2"></td>
                            <td class="report-cell" id="colReport-sun-3"></td>
                            <td class="report-cell" id="colReport-sun-4"></td>
                            <td class="report-cell" id="colReport-sun-5"></td>
                            <td class="report-cell" id="colReport-sun-6"></td>
                            <td class="report-cell" id="colReport-sun-7"></td>
                            <td class="report-cell" id="colReport-sun-8"></td>
                            <td class="report-cell" id="colReport-sun-9"></td>
                            <td class="report-cell" id="colReport-sun-10"></td>
                            <td class="report-cell" style="display:hidden"></td>
                        </tr>
                    </tbody>
                </table>            
        </div>
        <div class="table-mon">     
                <table id="dynamicTable-mon" class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Monday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable-mon" class="routineTable">
                    <tbody>
                        <tr>
                            <td class="report-cell" id="colReport-mon-0">Duplicate <br> Teachers <br> & rooms</td>
                            <td class="report-cell" id="colReport-mon-1"></td>
                            <td class="report-cell" id="colReport-mon-2"></td>
                            <td class="report-cell" id="colReport-mon-3"></td>
                            <td class="report-cell" id="colReport-mon-4"></td>
                            <td class="report-cell" id="colReport-mon-5"></td>
                            <td class="report-cell" id="colReport-mon-6"></td>
                            <td class="report-cell" id="colReport-mon-7"></td>
                            <td class="report-cell" id="colReport-mon-8"></td>
                            <td class="report-cell" id="colReport-mon-9"></td>
                            <td class="report-cell" id="colReport-mon-10"></td>
                            <td class="report-cell" style="display:hidden"></td>
                        </tr>
                    </tbody>
                </table>            
        </div>
        <div class="table-tue">     
                <table id="dynamicTable-tue" class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td><td style="justify-content: center" colspan="11"> Tuesday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable-tue" class="routineTable">
                    <tbody>
                        <tr>
                            <td class="report-cell" id="colReport-tue-0">Duplicate <br> Teachers <br> & rooms</td>
                            <td class="report-cell" id="colReport-tue-1"></td>
                            <td class="report-cell" id="colReport-tue-2"></td>
                            <td class="report-cell" id="colReport-tue-3"></td>
                            <td class="report-cell" id="colReport-tue-4"></td>
                            <td class="report-cell" id="colReport-tue-5"></td>
                            <td class="report-cell" id="colReport-tue-6"></td>
                            <td class="report-cell" id="colReport-tue-7"></td>
                            <td class="report-cell" id="colReport-tue-8"></td>
                            <td class="report-cell" id="colReport-tue-9"></td>
                            <td class="report-cell" id="colReport-tue-10"></td>
                            <td class="report-cell" style="display:hidden"></td>
                        </tr>
                    </tbody>
                </table>            
        </div>
        <div class="table-wed">     
                <table id="dynamicTable-wed" class="dynamicTable">
                    <thead>
                        <tr>
                            <th>Period →</th>
                            <th>1st </th> <th>2nd</th> <th>3rd </th>
                            <th>4th </th> <th>5th </th> <th>6th </th>
                            <th>7th </th> <th>8th </th> <th>9th </th>
                            <th>Duplicate Classes</th>
                            <th>Action</th>
                        </tr>
                        <tr>
                            <td id="highlight">Time →</td>
                            <td>8:00 - 8:50 AM</td>
                            <td>8:50 - 9:40 AM</td>
                            <td>9:40 - 10:30 AM</td>
                            <td>10:50 - 11:40 AM</td>
                            <td>11:40 - 12:30 PM</td>
                            <td>12:30 - 1:20 PM</td>
                            <td>2:30 - 3:20 PM</td>
                            <td>3:20 - 4:10 PM</td>
                            <td>4:10 - 5:00 PM</td>
                            <td colspan="2"></td>
                            
                        </tr>
                        <tr>
                            <td id="highlight">Day →</td>
                            <td style="justify-content: center" colspan="11"> Wednesday</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <table id="routineTable-wed" class="routineTable">
                    <tbody>
                        <tr>
                            <td class="report-cell" id="colReport-wed-0">Duplicate <br> Teachers <br> & rooms</td>
                            <td class="report-cell" id="colReport-wed-1"></td>
                            <td class="report-cell" id="colReport-wed-2"></td>
                            <td class="report-cell" id="colReport-wed-3"></td>
                            <td class="report-cell" id="colReport-wed-4"></td>
                            <td class="report-cell" id="colReport-wed-5"></td>
                            <td class="report-cell" id="colReport-wed-6"></td>
                            <td class="report-cell" id="colReport-wed-7"></td>
                            <td class="report-cell" id="colReport-wed-8"></td>
                            <td class="report-cell" id="colReport-wed-9"></td>
                            <td class="report-cell" id="colReport-wed-10"></td>
                            <td class="report-cell" style="display:hidden"></td>
                        </tr>
                    </tbody>
                </table>            
        </div>


        <div id="popup" class="popup">
            <h3>Edit Cell</h3>
            <label>Course Code: <input type="text" id="courseCode"></label>
    
            <!-- Teacher Section -->
            <div id="teacherContainer">
                <label>Teacher: <input type="text" name="teacher"></label>
            </div>
            <button type="button" onclick="addTeacher()">Add Teacher</button><br><br>
    
            <!-- Room Number Section -->
            <div id="roomContainer">
                <label>Room Number: <input type="text" name="room"></label>
            </div>
            <button type="button" onclick="addRoom()">Add Room</button><br><br>
            <br><br>
            <button onclick="saveCell()">Save</button>
            <button onclick="closePopup()">Cancel</button>
        </div>
    </div>

    <script>
        let batchCounter = 1;
        let selectedCell;
        let selectedTable;

        function openBatchPopup() {
            document.getElementById("batchPopup").style.display = "block";
        }

        function closeBatchPopup() {
            document.getElementById("batchPopup").style.display = "none";
        }
        
        function getLightColor() {
            // Generate R, G, B values in the range (150-255) to ensure a light color
            let r = 255; // 150 to 255
            let g = 255;
            let b = 255;
            return `rgb(${r}, ${g}, ${b})`;
        }


        // Add this function to sort the table rows by year seniority
        function sortTableBySeniority(day) {
            let table = document.getElementById(`dynamicTable-${day}`);
            let tbody = table.getElementsByTagName('tbody')[0];
            let rows = Array.from(tbody.rows);
            
            // Group rows by batch (each batch has 3 rows)
            let batches = [];
            for (let i = 0; i < rows.length; i += 3) {
                if (i + 2 < rows.length) {  // Ensure we have a complete batch
                    batches.push([rows[i], rows[i+1], rows[i+2]]);
                }
            }
            
            // Sort batches by year seniority
            batches.sort((a, b) => {
                // Extract year from the first cell of first row in batch
                let yearA = a[0].cells[0].innerText.split('\n')[0].split(' ')[0];
                let yearB = b[0].cells[0].innerText.split('\n')[0].split(' ')[0];
                
                // Convert year text to numeric value for sorting (4th = 4, 3rd = 3, etc.)
                let getYearValue = (yearText) => {
                    if (yearText === '4th') return 4;
                    if (yearText === '3rd') return 3;
                    if (yearText === '2nd') return 2;
                    if (yearText === '1st') return 1;
                    return 0;  // Default case
                };
                
                // Sort in descending order (higher year number = more senior)
                return getYearValue(yearB) - getYearValue(yearA);
            });
            
            // Clear tbody and re-add rows in sorted order
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            batches.forEach(batch => {
                batch.forEach(row => {
                    tbody.appendChild(row);
                });
            });
            
            // Update row reports after sorting
            checkDuplicates(day);
        }
        // Modify the addRows function to call sortTableBySeniority after adding rows
        function addRows() {
            const days = ['sat', 'sun', 'mon', 'tue', 'wed'];
            let year = document.getElementById("year").value;
            let semester = document.getElementById("semester").value;
            let batchName = document.getElementById("batchName").value;
            let sections = ["A section", "B section", "C section"];
            let color = getLightColor();
            
            days.forEach(day => {
                let table = document.getElementById(`dynamicTable-${day}`).getElementsByTagName('tbody')[0];
                let currentRow_number = table.rows.length + 1;
                let rowGroup = [];
                
                for (let i = 0; i < 3; i++) {
                    let newRow = table.insertRow();
                    rowGroup.push(newRow);
                    
                    for (let j = 0; j < 11; j++) {
                        let cell = newRow.insertCell(j);
                        cell.style.backgroundColor = color;
                        if (j === 0) {
                            cell.innerHTML = `${year} Year<br>${semester} Semester<br>${sections[i]}<br>(${batchName})`;
                        }
                        else if(j === 10) {
                            cell.classList.add("report-cell");
                            cell.setAttribute("id", `rowReport-${day}-${i + currentRow_number}`);
                        }
                        else {
                            cell.innerHTML = ``;
                            cell.onclick = function() { 
                                openPopup(this);
                                selectedTable = day;
                            };
                        }
                    }
                }
                
                // Add delete button to the first row of each batch
                let deleteCell = rowGroup[0].insertCell(11);
                let deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.onclick = function() { 
                    const dayRowGroups = {};
                    days.forEach(d => {
                        const tableBody = document.getElementById(`dynamicTable-${d}`).getElementsByTagName('tbody')[0];
                        const rowIndex = rowGroup[0].rowIndex - 3; // Adjust for header rows
                        dayRowGroups[d] = [
                            tableBody.rows[rowIndex],
                            tableBody.rows[rowIndex + 1],
                            tableBody.rows[rowIndex + 2]
                        ];
                    });
                    deleteRowsFromAllTables(dayRowGroups);
                };
                deleteCell.appendChild(deleteButton);
                
                // Sort table by year seniority after adding new batch
                sortTableBySeniority(day);
            });
            
            closeBatchPopup();
        }

        function deleteRowsFromAllTables(dayRowGroups) {
            let userResponse = confirm("Are you sure you want to delete this batch from all days?");
            if (userResponse) {
                for (let day in dayRowGroups) {
                    dayRowGroups[day].forEach(row => {
                        if (row) row.remove();
                    });
                }
                alert("Batch deleted successfully from all days!");
                
                // Update duplicate checks for all tables
                const days = ['sat', 'sun', 'mon', 'tue', 'wed'];
                days.forEach(day => {
                    checkDuplicates(day);
                });
            } else {
                alert("Delete operation canceled.");
            }
        }

        function openPopup(cell) {
            if (cell.classList.contains("report-cell")) return; 
            selectedCell = cell; // Store the clicked cell
            document.getElementById("popup").style.display = "block";

            // Pre-fill with existing values (if available)
            let existingData = cell.innerText.split("\n");
            document.getElementById("courseCode").value = existingData[0] || "";

            // Reset dynamic fields
            document.getElementById("teacherContainer").innerHTML = "";
            document.getElementById("roomContainer").innerHTML = "";

            if (existingData[1]) {
                existingData[1].split("/").forEach(teacher => addTeacher(teacher));
            } else {
                addTeacher(); // Add one empty teacher input
            }

            if (existingData[2]) {
                existingData[2].split("/").forEach(room => addRoom(room));
            } else {
                addRoom(); // Add one empty room input
            }
        }

        function closePopup() {
            document.getElementById("popup").style.display = "none";
        }

        function addTeacher(value = "") {
            let teacherContainer = document.getElementById("teacherContainer");
            let newTeacherInput = document.createElement("label");
            newTeacherInput.innerHTML = `Teacher: <input type="text" name="teacher" value="${value}"> 
                <button type="button" onclick="removeElement(this)">Remove</button>`;
            teacherContainer.appendChild(newTeacherInput);
        }

        function addRoom(value = "") {
            let roomContainer = document.getElementById("roomContainer");
            let newRoomInput = document.createElement("label");
            newRoomInput.innerHTML = `Room Number: <input type="text" name="room" value="${value}"> 
                <button type="button" onclick="removeElement(this)">Remove</button>`;
            roomContainer.appendChild(newRoomInput);
        }

        function removeElement(button) {
            button.parentElement.remove();
        }

        // Add this helper function to check teacher's classes in a day by section
        function getTeacherPeriodsInSection(day, teacherName, rowIndex) {
            let table = document.getElementById(`dynamicTable-${day}`);
            let row = table.rows[rowIndex];
            let periods = [];
            
            for (let j = 1; j < 10; j++) {
                if (row.cells[j] && row.cells[j].style.display !== "none") {
                    let cellText = row.cells[j].innerText.split("\n");
                    let teachers = cellText[1] ? cellText[1].split("/") : [];
                    
                    teachers = teachers.map(t => t.trim());
                    if (teachers.includes(teacherName)) {
                        periods.push(j);
                    }
                }
            }
            
            return periods.sort((a, b) => a - b);
        }

        // Function to check if a teacher is already teaching in another section at the same time
        function isTeacherBusy(day, teacherName, period, currentRowIndex) {
            let table = document.getElementById(`dynamicTable-${day}`);
            let rows = table.rows;
            
            for (let i = 3; i < rows.length; i++) {
                // Skip current row
                if (i === currentRowIndex) continue;
                
                if (rows[i].cells[period] && rows[i].cells[period].style.display !== "none") {
                    let cellText = rows[i].cells[period].innerText.split("\n");
                    let teachers = cellText[1] ? cellText[1].split("/") : [];
                    
                    teachers = teachers.map(t => t.trim());
                    if (teachers.includes(teacherName)) {
                        return true; // Teacher is busy in another section at this time
                    }
                }
            }
            
            return false;
        }
        function saveCell() {
            if (!selectedCell) return;

            let courseCode = document.getElementById("courseCode").value;
            let teachers = Array.from(document.getElementsByName("teacher")).map(input => input.value).filter(Boolean);
            let rooms = Array.from(document.getElementsByName("room")).map(input => input.value).filter(Boolean);
            let row = selectedCell.parentElement;
            let currentRowIndex = row.rowIndex;
            let cellIndex = Array.from(row.children).indexOf(selectedCell);
            
            // Get current cell index (period)
            let currentPeriod = cellIndex;
            
            // Check teacher constraints
            let teacherViolations = [];
            
            for (let teacher of teachers) {
                if (!teacher.trim()) continue;
                
                // Check if teacher is already teaching in another section at the same time
                if (isTeacherBusy(selectedTable, teacher.trim(), currentPeriod, currentRowIndex)) {
                    teacherViolations.push(`${teacher} is already teaching in another section at this time.`);
                    continue;
                }
                
                // Check teacher's classes in the current section
                let teacherPeriods = getTeacherPeriodsInSection(selectedTable, teacher.trim(), currentRowIndex);
                
                // Remove current period if it's already in the list (for edit case)
                teacherPeriods = teacherPeriods.filter(p => p !== currentPeriod);
                
                // Add the new period
                teacherPeriods.push(currentPeriod);
                teacherPeriods.sort((a, b) => a - b);
                
                // If teacher has more than 2 classes in this section
                if (teacherPeriods.length > 2) {
                    teacherViolations.push(`${teacher} can teach at most 2 classes in the same section.`);
                    continue;
                }
                
                // Check if 2 classes in the same section are not adjacent
                if (teacherPeriods.length === 2 && Math.abs(teacherPeriods[0] - teacherPeriods[1]) !== 1) {
                    teacherViolations.push(`${teacher}'s classes in this section must be in adjacent periods. Current periods: ${teacherPeriods.map(p => p).join(", ")}`);
                }
            }
            
            // If there are violations, show alert and update the duplicate report
            if (teacherViolations.length > 0) {
                alert("Teacher constraint violations:\n" + teacherViolations.join("\n"));
                
                // Update the duplicate report cell
                const colReportId = `colReport-${selectedTable}-${currentPeriod}`;
                const colReportCell = document.getElementById(colReportId);
                if (colReportCell) {
                    let currentText = colReportCell.innerText;
                    let parts = currentText.split("\n");
                    colReportCell.innerText = `${parts[0]}\n${parts[1]}\nViolations: ${teacherViolations.join("; ")}`;
                }
                
                closePopup();
                return;
            }
            

        // Continue with the original saveCell logic

            let lastChar = courseCode.trim().slice(-1); // Get the last character
            let lastDigit = parseInt(lastChar, 10); // Convert to number
            
            if (!isNaN(lastDigit)) {
                if (lastDigit % 2 === 0) {
                    let lab_positions = [1, 4, 7];
                    if (!lab_positions.includes(cellIndex)) {
                        alert(`Sessional courses are only allowed in 1st, 4th, and 7th periods.`);
                        closePopup();
                        return;
                    }
                    selectedCell.setAttribute("colspan", "3");
                    let next1 = row.children[cellIndex + 1];
                    let next2 = row.children[cellIndex + 2];

                    if (next1) {
                        next1.innerText = `${courseCode},${teachers.join("/")},${rooms.join("/")}`;
                        next1.style.display = "none";
                    }
                    if (next2) {
                        next2.innerText = `${courseCode},${teachers.join("/")},${rooms.join("/")}`;
                        next2.style.display = "none";
                    }
                } else {
                    selectedCell.setAttribute("colspan", "1");
                    // Restore hidden cells
                    let next1 = row.children[cellIndex + 1];
                    let next2 = row.children[cellIndex + 2];
                    if (next1) {
                        if (next1.style.display == "none") {
                            next1.style.display = "table-cell";
                            next1.innerText = "";
                        }
                    }
                    if (next2) {
                        if (next2.style.display == "none") {
                            next2.style.display = "table-cell";
                            next2.innerText = "";
                        }
                    }
                }
                selectedCell.innerText = `${courseCode}\n${teachers.join("/")}\n${rooms.join("/")}`;
                checkDuplicates(selectedTable);
                closePopup();
            } else if (!courseCode) {
                selectedCell.setAttribute("colspan", "1");
                // Restore hidden cells
                let next1 = row.children[cellIndex + 1];
                let next2 = row.children[cellIndex + 2];
                if (next1) {
                    if (next1.style.display == "none") {
                        next1.style.display = "table-cell";
                        next1.innerText = "";
                    }
                }
                if (next2) {
                    if (next2.style.display == "none") {
                        next2.style.display = "table-cell";
                        next2.innerText = "";
                    }
                }
                selectedCell.innerText = "";
                checkDuplicates(selectedTable);
                closePopup();
            } else {
                alert("Invalid course code. Please enter a valid course code.");
                closePopup();
                return;
            }
        }

        function checkDuplicates(day) {
            let rowwise_table = document.getElementById(`dynamicTable-${day}`);
            let rows = rowwise_table.rows;
            
            // Check row-wise duplicates (duplicate courses in the same row)
            for (let i = 3; i < rows.length; i++) { // Start from index 3 to skip header rows
                let firstLineSet = new Set();
                let firstLineDuplicates = [];

                for (let j = 1; j < 10; j++) {
                    if (rows[i].cells[j] && rows[i].cells[j].style.display == "none") {
                        continue;
                    }
                    let cellText = rows[i].cells[j] ? rows[i].cells[j].innerText.split("\n") : [];
                    let firstLine = cellText[0] || "";

                    if (firstLine && firstLineSet.has(firstLine)) firstLineDuplicates.push(firstLine);
                    else if (firstLine) firstLineSet.add(firstLine);
                }
                
                const rowReportId = `rowReport-${day}-${i - 2}`; // Adjust index for header rows
                const rowReportCell = document.getElementById(rowReportId);
                if (rowReportCell) {
                    rowReportCell.innerText = `${[...new Set(firstLineDuplicates)].join(", ")}`;
                }
            }

            // Check column-wise duplicates (duplicate teachers and rooms in the same time slot)
            for (let j = 1; j < 10; j++) {
                let secondLineSet = new Set();
                let thirdLineSet = new Set();
                let secondLineDuplicates = [];
                let thirdLineDuplicates = [];

                for (let i = 3; i < rows.length; i++) { // Start from index 3 to skip header rows
                    if (!rows[i].cells[j] || rows[i].cells[j].style.display == "none") {
                        continue;
                    }
                    
                    let cellText = rows[i].cells[j].innerText.split("\n");
                    let secondLine = cellText[1] || "";
                    let thirdLine = cellText[2] || "";

                    if (secondLine) {
                        secondLine.split("/").forEach(teacher => {
                            teacher = teacher.trim();
                            if (teacher && secondLineSet.has(teacher)) secondLineDuplicates.push(teacher);
                            else if (teacher) secondLineSet.add(teacher);
                        });
                    }
                    
                    if (thirdLine) {
                        thirdLine.split("/").forEach(room => {
                            room = room.trim();
                            if (room && thirdLineSet.has(room)) thirdLineDuplicates.push(room);
                            else if (room) thirdLineSet.add(room);
                        });
                    }
                }

                const colReportId = `colReport-${day}-${j}`;
                const colReportCell = document.getElementById(colReportId);
                if (colReportCell) {
                    colReportCell.innerText = `T:[${[...new Set(secondLineDuplicates)].join(", ")}]\nR:[${[...new Set(thirdLineDuplicates)].join(", ")}]`;
                }
            }
        }

        // Initialize all tables' duplicate checking when the page loads
        window.onload = function() {
            const days = ['sat', 'sun', 'mon', 'tue', 'wed'];
            days.forEach(day => {
                checkDuplicates(day);
            });
        };
    </script>
</body>
</html>